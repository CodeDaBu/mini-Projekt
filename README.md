
# README - Opis SQL struktur in funkcij

---

## Tabele

### `drzave`

```sql
create table if not exists drzave
(
    id   integer generated by default as identity
        primary key,
    ime  varchar,
    koda varchar
);
```

**Kaj počne:**  
Shranjuje države z ID-jem, imenom in kodo države (npr. SI, HR...).

---

### `kraj`

```sql
create table if not exists kraj
(
    id        integer generated by default as identity
        primary key,
    ime       varchar,
    postna_st varchar,
    drzava_id integer
        references drzave
        constraint kraj_drzava_fkey
            references drzave
);
```

**Kaj počne:**  
Shranjuje kraje, ki so povezani z državo preko `drzava_id`. Vsak kraj ima ime in poštno številko.

---

### `radio`

```sql
create table if not exists radio
(
    id            integer generated by default as identity
        primary key,
    ime           varchar,
    frekvenca     double precision,
    channel       varchar,
    valid_until   date,
    phone         varchar,
    email         varchar,
    kraj_id       integer
        references kraj,
    comment_count integer   default 0,
    last_modified timestamp default CURRENT_TIMESTAMP
);
```

**Kaj počne:**  
Shranjuje radijske postaje z osnovnimi podatki, vključno s frekvenco, kontaktom, krajem, številom komentarjev in časom zadnje spremembe.

---

### `users`

```sql
create table if not exists users
(
    id         integer generated by default as identity
        primary key,
    username   varchar,
    password   varchar,
    email      varchar,
    phone      varchar,
    kraj_id    integer
        references kraj,
    created_at timestamp,
    updated_at timestamp
);
```

**Kaj počne:**  
Shranjuje uporabnike sistema z njihovimi podatki in povezavo do kraja.

---

### `comments`

```sql
create table if not exists comments
(
    id           integer generated by default as identity
        primary key,
    comment_text text,
    frequency_id integer
        references radio,
    user_id      integer
        references users,
    created_at   timestamp
);
```

**Kaj počne:**  
Shranjuje komentarje uporabnikov, ki so povezani z določenimi radijskimi postajami.

---

### `log_radio`

```sql
create table if not exists log_radio
(
    id            serial
        primary key,
    radio_id      integer,
    ime           varchar,
    frekvenca     double precision,
    channel       varchar,
    valid_until   date,
    phone         varchar,
    email         varchar,
    kraj_id       integer,
    comment_count integer,
    last_modified timestamp,
    log_timestamp timestamp default CURRENT_TIMESTAMP
);
```

**Kaj počne:**  
Shranjuje zgodovinske podatke o radijskih postajah (logiranje sprememb).

---

## Funkcije

---

### `check_user_validity`

```sql
create or replace function check_user_validity(p_username text, p_password text) returns boolean
    language plpgsql
as
$$
DECLARE
    user_exists BOOLEAN;
BEGIN
    SELECT EXISTS(SELECT 1 FROM users WHERE username = p_username AND password = p_password) INTO user_exists;
    RETURN user_exists;
END;
$$;
```

**Kaj počne:**  
Preveri, ali uporabnik z določenim uporabniškim imenom in geslom obstaja. Vrne `true`, če obstaja, drugače `false`.

---

### `register_new_user`

```sql
create or replace function register_new_user(p_username text, p_password text) returns void
    language plpgsql
as
$$
BEGIN
    INSERT INTO users (username, password) VALUES (p_username, p_password);
END;
$$;
```

**Kaj počne:**  
Doda novega uporabnika z uporabniškim imenom in geslom v tabelo `users`.

---

### `get_user_id`

```sql
create or replace function get_user_id(p_username text) returns integer
    language plpgsql
as
$$
DECLARE
    user_id INT;
BEGIN
    SELECT id INTO user_id FROM users WHERE username = p_username;
    RETURN user_id;
END;
$$;
```

**Kaj počne:**  
Vrne ID uporabnika glede na uporabniško ime.

---

### `update_comment_count`

```sql
create or replace function update_comment_count() returns trigger
    language plpgsql
as
$$
BEGIN
  UPDATE radio
  SET comment_count = (
    SELECT COUNT(*) FROM comments WHERE frequency_id = NEW.frequency_id
  )
  WHERE id = NEW.frequency_id;
  RETURN NEW;
END;
$$;
```

**Kaj počne:**  
Trigger funkcija, ki posodobi število komentarjev za radijsko postajo, ko se doda nov komentar.

---

### `comment_count_trigger`

```sql
create trigger comment_count_trigger
    after insert
    on comments
    for each row
execute procedure update_comment_count();
```

**Kaj počne:**  
Trigger, ki ob vstavljanju novega komentarja pokliče funkcijo `update_comment_count()`.

---

### `prijava_uporabnika`

```sql
create or replace function prijava_uporabnika(p_username text, p_password text) returns integer
    language plpgsql
as
$$
DECLARE
    uid INT;
BEGIN
    SELECT id INTO uid
    FROM users
    WHERE username = p_username
      AND password = crypt(p_password, password);

    IF uid IS NOT NULL THEN
        RETURN uid;
    ELSE
        RETURN -1;
    END IF;
END;
$$;
```

**Kaj počne:**  
Preveri prijavo uporabnika z uporabo varnega preverjanja gesla (`crypt`). Če prijava uspe, vrne ID uporabnika, drugače `-1`.

---

### `registracija_uporabnika`

```sql
create or replace function registracija_uporabnika(p_username text, p_password text) returns boolean
    language plpgsql
as
$$
BEGIN
    IF EXISTS (SELECT 1 FROM users WHERE username = p_username) THEN
        RETURN FALSE;
    END IF;

    INSERT INTO users (username, password)
    VALUES (p_username, crypt(p_password, gen_salt('bf')));

    RETURN TRUE;
END;
$$;
```

**Kaj počne:**  
Registrira novega uporabnika. Najprej preveri, če uporabnik že obstaja, če ne, ga ustvari in geslo varno shrani s `crypt` in `gen_salt`.

---

### `pridobi_radio_id`

```sql
create or replace function pridobi_radio_id(po_ime text) returns integer
    language plpgsql
as
$$
DECLARE
    rid INT;
BEGIN
    SELECT id INTO rid FROM radio WHERE ime = po_ime;
    RETURN rid;
END;
$$;
```

**Kaj počne:**  
Vrne ID radijske postaje glede na ime.

---

### `dodaj_komentar`

```sql
create or replace function dodaj_komentar(p_comment_text text, p_frequency_id integer, p_user_id integer) returns void
    language plpgsql
as
$$
BEGIN
    INSERT INTO comments (comment_text, frequency_id, user_id, created_at)
    VALUES (p_comment_text, p_frequency_id, p_user_id, CURRENT_TIMESTAMP);
END;
$$;
```

**Kaj počne:**  
Doda komentar v bazo, povezan z določeno radijsko postajo in uporabnikom.

---

### `count_comments`

```sql
create or replace function count_comments(radio_id integer) returns integer
    language plpgsql
as
$$
BEGIN
    RETURN (SELECT COUNT(*) FROM comments WHERE frequency_id = radio_id);
END;
$$;
```

**Kaj počne:**  
Prešteje in vrne število komentarjev za določeno radijsko postajo.

---

### `update_last_modified`

```sql
create or replace function update_last_modified() returns trigger
    language plpgsql
as
$$
BEGIN
    NEW.last_modified = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$;
```

**Kaj počne:**  
Trigger funkcija, ki ob posodobitvi radijske postaje nastavi `last_modified` na trenutni čas.

---

### `trigger_update_last_modified`

```sql
create trigger trigger_update_last_modified
    before update
    on radio
    for each row
execute procedure update_last_modified();
```

**Kaj počne:**  
Trigger, ki ob posodobitvi tabele `radio` pokliče `update_last_modified()`.

---

### `pridobi_vse_radio_postaje`

```sql
create or replace function pridobi_vse_radio_postaje()
    returns TABLE(id integer, ime character varying, frekvenca double precision)
    language plpgsql
as
$$
BEGIN
    RETURN QUERY
    SELECT r.id, r.ime, r.frekvenca
    FROM radio r;
END;
$$;
```

**Kaj počne:**  
Vrne tabelo z vsemi radijskimi postajami in njihovimi osnovnimi podatki.

---

### `update_radio_last_modified`

```sql
create or replace function update_radio_last_modified() returns trigger
    language plpgsql
as
$$
BEGIN
    UPDATE radio
    SET last_modified = CURRENT_TIMESTAMP
    WHERE id = NEW.frequency_id;
    RETURN NEW;
END;
$$;
```

**Kaj počne:**  
Trigger funkcija, ki posodobi `last_modified` radijske postaje ob vstavitvi novega komentarja.

---

### `update_radio_last_modified` trigger

```sql
create trigger update_radio_last_modified
    after insert
    on comments
    for each row
execute procedure update_radio_last_modified();
```

**Kaj počne:**  
Trigger, ki ob vstavljanju komentarja sproži funkcijo za posodobitev datuma zadnje spremembe radijske postaje.

---

### `pridobi_podrobnosti_radia`

```sql
create or replace function pridobi_podrobnosti_radia(po_ime text)
    returns TABLE(id integer, ime character varying, frekvenca double precision, channel character varying, valid_until date, phone character varying, email character varying)
    language plpgsql
as
$$
BEGIN
    RETURN QUERY
    SELECT r.id, r.ime, r.frekvenca, r.channel, r.valid_until, r.phone, r.email
    FROM radio r
    WHERE r.ime = po_ime;
END;
$$;
```

**Kaj počne:**  
Vrne vse podrobnosti o radijski postaji glede na njeno ime.
